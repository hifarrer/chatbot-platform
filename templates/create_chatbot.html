{% extends "base.html" %}

{% block title %}Create Chatbot - owlbee.ai{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus me-2"></i>Create New Chatbot</h4>
            </div>
            <div class="card-body">
                <!-- Plan Information -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Current Plan:</strong> {{ user_plan.name }}
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                {{ current_chatbot_count }}/{{ user_plan.chatbot_limit }} chatbots used
                            </small>
                        </div>
                    </div>
                    {% if remaining_chatbots <= 0 %}
                        <div class="mt-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            <strong>Plan Limit Reached:</strong> You have reached your chatbot limit. 
                            <a href="{{ url_for('plans') }}" class="alert-link">Upgrade your plan</a> to create more chatbots.
                        </div>
                    {% elif remaining_chatbots <= 1 %}
                        <div class="mt-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            <strong>Almost at limit:</strong> You have {{ remaining_chatbots }} chatbot{{ 's' if remaining_chatbots != 1 else '' }} remaining.
                        </div>
                    {% endif %}
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">Chatbot Name</label>
                        <input type="text" class="form-control" id="name" name="name" required
                               placeholder="e.g., Customer Support Bot, FAQ Bot">
                        <div class="form-text">Give your chatbot a descriptive name</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Describe what this chatbot will be used for..."></textarea>
                        <div class="form-text">Optional: Describe the purpose and scope of this chatbot</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chatbot Avatar</label>
                        
                        <!-- Avatar Selection Tabs -->
                        <ul class="nav nav-tabs mb-3" id="avatarTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab">
                                    <i class="fas fa-upload me-1"></i>Upload Custom
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="predefined-tab" data-bs-toggle="tab" data-bs-target="#predefined-pane" type="button" role="tab">
                                    <i class="fas fa-images me-1"></i>Choose from Gallery
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="avatarTabContent">
                            <!-- Upload Tab -->
                            <div class="tab-pane fade show active" id="upload-pane" role="tabpanel">
                                <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                                <div class="form-text">Upload a custom avatar image (PNG, JPG, GIF, SVG - max 2MB)</div>
                            </div>
                            
                            <!-- Predefined Avatars Tab -->
                            <div class="tab-pane fade" id="predefined-pane" role="tabpanel">
                                <div class="row g-2">
                                    {% for i in range(1, 7) %}
                                    <div class="col-4 col-md-2">
                                        <div class="avatar-option" data-avatar="{{ i }}.png">
                                            <img src="{{ url_for('static', filename='avatars/' + i|string + '.png') }}" 
                                                 alt="Avatar {{ i }}" 
                                                 class="img-thumbnail avatar-preview"
                                                 style="width: 100%; height: 100px; object-fit: cover; cursor: pointer; border: 2px solid transparent;">
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="selected-avatar" name="selected_avatar" value="">
                                <div class="form-text mt-2">Click on an avatar to select it</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="greeting_message" class="form-label">Greeting Message</label>
                        <input type="text" class="form-control" id="greeting_message" name="greeting_message" 
                               placeholder="e.g., Need help? Ask me anything!" maxlength="500">
                        <div class="form-text">Optional: Custom greeting message that appears when users first interact with your chatbot</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="system_prompt" class="form-label">System Prompt <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="system_prompt" name="system_prompt" rows="4" required
                                  placeholder="You are a customer support chatbot for a computer store. You help customers with product information, troubleshooting, and purchase decisions. Be friendly, professional, and helpful.">You are a helpful AI assistant. Answer questions based on the provided documents and your general knowledge.</textarea>
                        <div class="form-text">
                            <i class="fas fa-lightbulb text-warning me-1"></i>
                            <strong>This defines your chatbot's personality and role.</strong> Examples:
                            <ul class="mt-2 mb-0">
                                <li>"You are a customer support agent for [Company]. Be professional and helpful."</li>
                                <li>"You are a technical documentation assistant. Provide clear, step-by-step guidance."</li>
                                <li>"You are a friendly FAQ bot. Answer questions about our services with enthusiasm."</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Next Steps:</strong> After creating your chatbot, you'll be able to upload documents to train it and get the embed code.
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-robot me-2"></i>Create Chatbot
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb me-2"></i>Tips for Success</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Choose a clear, descriptive name for your chatbot
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Upload relevant documents (PDF, DOCX, TXT) for training
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Test your chatbot before embedding it on your website
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Keep your training documents focused on specific topics
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle predefined avatar selection
    const avatarOptions = document.querySelectorAll('.avatar-option');
    const selectedAvatarInput = document.getElementById('selected-avatar');
    const fileInput = document.getElementById('avatar');
    
    avatarOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all options
            avatarOptions.forEach(opt => {
                opt.querySelector('img').style.border = '2px solid transparent';
            });
            
            // Add active class to selected option
            this.querySelector('img').style.border = '2px solid #007bff';
            
            // Set the selected avatar value
            const avatarName = this.getAttribute('data-avatar');
            selectedAvatarInput.value = avatarName;
            
            // Clear file input when predefined avatar is selected
            fileInput.value = '';
        });
    });
    
    // Clear predefined selection when file is uploaded
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            // Clear predefined selection
            selectedAvatarInput.value = '';
            avatarOptions.forEach(opt => {
                opt.querySelector('img').style.border = '2px solid transparent';
            });
        }
    });
    
    // Handle tab switching
    const uploadTab = document.getElementById('upload-tab');
    const predefinedTab = document.getElementById('predefined-tab');
    
    uploadTab.addEventListener('click', function() {
        // Clear predefined selection when switching to upload tab
        selectedAvatarInput.value = '';
        avatarOptions.forEach(opt => {
            opt.querySelector('img').style.border = '2px solid transparent';
        });
    });
    
    predefinedTab.addEventListener('click', function() {
        // Clear file input when switching to predefined tab
        fileInput.value = '';
    });
});
</script>

<style>
.avatar-preview:hover {
    border-color: #007bff !important;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

.avatar-option.selected img {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.avatar-option {
    padding: 5px;
    min-height: 110px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<!-- Platform Assistant Chatbot -->
{% if homepage_chatbot %}
<div id="chatbot-container"></div>
<script src="{{ url_for('static', filename='js/chatbot-embed.js') }}"></script>
<script>
window.addEventListener('load', function() {
    // Initialize the Platform Assistant chatbot
    ChatbotEmbed.init({
        embedCode: '{{ homepage_chatbot.embed_code }}',
        apiUrl: '{{ request.url_root }}api/chat/{{ homepage_chatbot.embed_code }}',
        containerId: 'chatbot-container',
        title: '{{ homepage_chatbot_title }}',
        placeholder: '{{ homepage_chatbot_placeholder }}',
        avatarUrl: '{% if homepage_chatbot.avatar_filename %}{{ get_avatar_url(homepage_chatbot.avatar_filename) }}{% endif %}',
        greetingMessage: '{{ homepage_chatbot.greeting_message or "Hi! I\'m here to help. Ask me anything!" }}',
        theme: 'light',
        position: 'bottom-right'
    });
});
</script>
{% endif %}

{% endblock %} 