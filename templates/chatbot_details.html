{% extends "base.html" %}

{% block title %}{{ chatbot.name }} - owlbee.ai{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-robot me-2"></i>{{ chatbot.name }}
        {% if chatbot.is_trained %}
            <span class="badge bg-success ms-2">Trained</span>
        {% else %}
            <span class="badge bg-warning ms-2">Not Trained</span>
        {% endif %}
    </h2>
    <div>
        {% if chatbot.is_trained %}
        <button class="btn btn-info me-2" onclick="showEmbedCode('{{ chatbot.embed_code }}')">
            <i class="fas fa-code me-1"></i>Get Embed Code
        </button>
        <a href="{{ url_for('preview_chatbot', embed_code=chatbot.embed_code) }}" target="_blank" class="btn btn-success me-2" style="display: none;">
            <i class="fas fa-eye me-1"></i>Preview
        </a>
        <a href="{{ url_for('web_preview_chatbot', embed_code=chatbot.embed_code) }}" target="_blank" class="btn btn-warning me-2">
            <i class="fas fa-globe me-1"></i>Web Preview
        </a>
        {% endif %}
        <button class="btn btn-danger" onclick="confirmDelete()">
            <i class="fas fa-trash me-1"></i>Delete Chatbot
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Chatbot Info -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-info-circle me-2"></i>Chatbot Information</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleEditMode()">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
            </div>
            <div class="card-body">
                <div id="view-mode">
                    <div class="row">
                        <div class="col-md-8">
                            <p><strong>Description:</strong> {{ chatbot.description or 'No description provided' }}</p>
                            <p><strong>Created:</strong> {{ chatbot.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p><strong>Embed Code:</strong> <code>{{ chatbot.embed_code }}</code></p>
                            <p><strong>Greeting Message:</strong> {{ chatbot.greeting_message or 'No custom greeting set' }}</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="mb-3">
                                <strong>Avatar:</strong>
                                {% if chatbot.avatar_filename %}
                                    <div class="mt-2">
                                        <img src="{{ get_avatar_url(chatbot.avatar_filename) }}" 
                                             alt="Chatbot Avatar" 
                                             class="img-thumbnail" 
                                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%;">
                                    </div>
                                {% else %}
                                    <div class="mt-2">
                                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" 
                                             style="width: 80px; height: 80px;">
                                            <i class="fas fa-robot fa-2x text-muted"></i>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>System Prompt:</strong>
                        <div class="bg-light p-3 rounded mt-2" style="white-space: pre-wrap;">{{ chatbot.system_prompt or 'No system prompt set' }}</div>
                    </div>
                </div>
                <div id="edit-mode" style="display: none;">
                    <form id="update-chatbot-form" action="{{ url_for('update_chatbot', chatbot_id=chatbot.id) }}" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-description" name="description" rows="2">{{ chatbot.description or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-greeting-message" class="form-label">Greeting Message</label>
                            <input type="text" class="form-control" id="edit-greeting-message" name="greeting_message" 
                                   value="{{ chatbot.greeting_message or '' }}" maxlength="500"
                                   placeholder="e.g., Need help? Ask me anything!">
                            <div class="form-text">Custom greeting message that appears when users first interact with your chatbot</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Avatar</label>
                            
                            <!-- Current Avatar Display -->
                            {% if chatbot.avatar_filename %}
                                <div class="mb-3">
                                    <small class="text-muted">Current avatar:</small>
                                    <img src="{{ get_avatar_url(chatbot.avatar_filename) }}" 
                                         alt="Current Avatar" 
                                         class="img-thumbnail ms-2" 
                                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
                                </div>
                            {% endif %}
                            
                            <!-- Avatar Selection Tabs -->
                            <ul class="nav nav-tabs mb-3" id="editAvatarTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="edit-upload-tab" data-bs-toggle="tab" data-bs-target="#edit-upload-pane" type="button" role="tab">
                                        <i class="fas fa-upload me-1"></i>Upload Custom
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="edit-predefined-tab" data-bs-toggle="tab" data-bs-target="#edit-predefined-pane" type="button" role="tab">
                                        <i class="fas fa-images me-1"></i>Choose from Gallery
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="editAvatarTabContent">
                                <!-- Upload Tab -->
                                <div class="tab-pane fade show active" id="edit-upload-pane" role="tabpanel">
                                    <input type="file" class="form-control" id="edit-avatar" name="avatar" accept="image/*">
                                    <div class="form-text">Upload a new avatar image (PNG, JPG, GIF, SVG - max 2MB)</div>
                                </div>
                                
                                <!-- Predefined Avatars Tab -->
                                <div class="tab-pane fade" id="edit-predefined-pane" role="tabpanel">
                                    <div class="row g-2">
                                        {% for i in range(1, 7) %}
                                        <div class="col-4 col-md-2">
                                            <div class="edit-avatar-option" data-avatar="{{ i }}.png">
                                                <img src="{{ url_for('static', filename='avatars/' + i|string + '.png') }}" 
                                                     alt="Avatar {{ i }}" 
                                                     class="img-thumbnail avatar-preview"
                                                     style="width: 100%; height: 100px; object-fit: cover; cursor: pointer; border: 2px solid transparent;">
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" id="edit-selected-avatar" name="selected_avatar" value="">
                                    <div class="form-text mt-2">Click on an avatar to select it</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-system-prompt" class="form-label">System Prompt</label>
                            <textarea class="form-control" id="edit-system-prompt" name="system_prompt" rows="4" required>{{ chatbot.system_prompt or '' }}</textarea>
                            <div class="form-text">
                                <i class="fas fa-lightbulb text-warning me-1"></i>
                                Define your chatbot's personality and role (e.g., "You are a customer support agent...")
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Document Upload -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-upload me-2"></i>Upload Training Documents</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('upload_document', chatbot_id=chatbot.id) }}" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" class="form-control" name="file" accept=".pdf,.docx,.txt" required>
                        <div class="form-text">Supported formats: PDF, DOCX, TXT (Max {{ current_user.user_plan.file_size_limit_mb }}MB for your {{ current_user.user_plan.name }} plan)</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Document
                    </button>
                </form>
            </div>
        </div>

        <!-- Uploaded Documents -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-alt me-2"></i>Training Documents ({{ documents|length }})</h5>
                {% if documents %}
                <button type="button" class="btn btn-success" onclick="confirmTraining()">
                    <i class="fas fa-brain me-2"></i>
                    {% if chatbot.is_trained %}
                        Retrain Chatbot
                    {% else %}
                        Train Chatbot
                    {% endif %}
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if documents %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Uploaded</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file me-2"></i>{{ doc.original_filename }}
                                    </td>
                                    <td>{{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if doc.processed %}
                                            <span class="badge bg-success">Processed</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('download_document', document_id=doc.id) }}" 
                                               class="btn btn-outline-primary" title="Download Document">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <form action="{{ url_for('delete_document', document_id=doc.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this document? This action cannot be undone.')">
                                                <button type="submit" class="btn btn-outline-danger" title="Delete Document">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No documents uploaded yet</h5>
                        <p class="text-muted">Upload documents to train your chatbot</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Test Chat -->
        <div class="card mb-4" id="test-chat-section" style="display: {% if chatbot.is_trained %}block{% else %}none{% endif %};">
            <div class="card-header">
                <h5><i class="fas fa-comments me-2"></i>Test Your Chatbot</h5>
            </div>
            <div class="card-body">
                <div id="chat-messages" class="chat-messages mb-3" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                    <div class="alert alert-info">
                        <i class="fas fa-robot me-2"></i>Hi! I'm your chatbot. Ask me anything based on the documents you've uploaded.
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="chat-input" placeholder="Type your message..." onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="mt-2 text-center">
                    <button id="end-conversation-btn" class="btn btn-outline-danger btn-sm" onclick="showEndConversationDialog()">
                        <i class="fas fa-times me-1"></i>End Conversation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ documents|length }}</h4>
                        <small class="text-muted">Documents</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ conversations|length }}</h4>
                        <small class="text-muted">Conversations</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Conversations -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history me-2"></i>Recent Conversations</h5>
            </div>
            <div class="card-body">
                {% if conversations %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for conv in conversations[:10] %}
                        <div class="border-bottom pb-2 mb-2">
                            <small class="text-muted">{{ conv.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                            <div class="small"><strong>User:</strong> {{ conv.user_message[:100] }}{% if conv.user_message|length > 100 %}...{% endif %}</div>
                            <div class="small text-muted"><strong>Bot:</strong> {{ conv.bot_response[:100] }}{% if conv.bot_response|length > 100 %}...{% endif %}</div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">No conversations yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Embed Code Modal -->
<div class="modal fade" id="embedModal" tabindex="-1" aria-labelledby="embedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="embedModalLabel">
                    <i class="fas fa-code me-2"></i>Embed Code for {{ chatbot.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Copy and paste this code into your website where you want the chatbot to appear:</p>
                <div class="position-relative">
                    <pre class="bg-light p-3 rounded"><code id="embedCode"></code></pre>
                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                            onclick="copyEmbedCode()" id="copyBtn">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Replace <code>YOUR_DOMAIN</code> with your actual domain name where this platform is hosted.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Training Confirmation Modal -->
<div class="modal fade" id="trainingModal" tabindex="-1" aria-labelledby="trainingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trainingModalLabel">
                    <i class="fas fa-brain me-2 text-success"></i>Confirm Training
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to train this chatbot?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Training Process:</strong> This will process all uploaded documents and create embeddings for your chatbot.
                </div>
                <p class="text-muted">This may take a few minutes depending on the number and size of documents.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="trainingBtn" onclick="startTraining()">
                    <i class="fas fa-brain me-2"></i>
                    <span id="trainingBtnText">
                        {% if chatbot.is_trained %}
                            Retrain Chatbot
                        {% else %}
                            Train Chatbot
                        {% endif %}
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ chatbot.name }}</strong>?</p>
                <p class="text-danger">This action cannot be undone. All documents, conversations, and training data will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('delete_chatbot', chatbot_id=chatbot.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Chatbot
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showEmbedCode(embedCode) {
    const domain = window.location.origin;
    const code = `<div id="chatbot-${embedCode}"></div>
<script src="${domain}/static/js/chatbot-embed.js"><\/script>
<script>
ChatbotEmbed.init({
    embedCode: '${embedCode}',
    apiUrl: '${domain}/api/chat/${embedCode}',
    containerId: 'chatbot-${embedCode}',
    title: '{{ chatbot.name }}',
    avatarUrl: '{% if chatbot.avatar_filename %}{{ domain }}/static/uploads/{{ chatbot.avatar_filename }}{% endif %}',
    greetingMessage: '{{ chatbot.greeting_message or "Hi! I'm here to help. Ask me anything!" }}'
});
<\/script>`;
    
    document.getElementById('embedCode').textContent = code;
    const modal = new bootstrap.Modal(document.getElementById('embedModal'));
    modal.show();
}

function copyEmbedCode() {
    const code = document.getElementById('embedCode').textContent;
    navigator.clipboard.writeText(code).then(function() {
        const btn = document.getElementById('copyBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}


function toggleEditMode() {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    
    if (viewMode.style.display === 'none') {
        // Switch to view mode
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
    } else {
        // Switch to edit mode
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    }
}

function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function confirmTraining() {
    const modal = new bootstrap.Modal(document.getElementById('trainingModal'));
    modal.show();
}

function startTraining() {
    const trainingBtn = document.getElementById('trainingBtn');
    const trainingBtnText = document.getElementById('trainingBtnText');
    
    if (!trainingBtn || !trainingBtnText) {
        console.error('Training button elements not found');
        return;
    }
    
    const trainingIcon = trainingBtn.querySelector('i');
    
    // Update button to show loading state
    trainingBtn.disabled = true;
    trainingIcon.className = 'fas fa-spinner fa-spin me-2';
    trainingBtnText.textContent = 'Training...';
    trainingBtn.classList.remove('btn-success');
    trainingBtn.classList.add('btn-warning');
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('trainingModal'));
    modal.hide();
    
    // Show training progress notification
    showTrainingProgress();
    
    // Send AJAX request
    fetch(`/train_chatbot/{{ chatbot.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            // Training successful
            trainingBtn.disabled = false;
            trainingIcon.className = 'fas fa-check me-2';
            trainingBtnText.textContent = 'Training Complete!';
            trainingBtn.classList.remove('btn-warning');
            trainingBtn.classList.add('btn-success');
            
            // Update chatbot status in UI
            updateChatbotStatus(true);
            
            // Update all document status badges to "Processed"
            updateDocumentStatus();
            
            // Show success message
            showTrainingSuccess();
            
            // Reset button after 3 seconds
            setTimeout(() => {
                trainingIcon.className = 'fas fa-brain me-2';
                trainingBtnText.textContent = '{{ "Retrain Chatbot" if chatbot.is_trained else "Train Chatbot" }}';
            }, 3000);
        } else {
            throw new Error(data.error || 'Training failed');
        }
    })
    .catch(error => {
        console.error('Training error:', error);
        
        // Training failed
        trainingBtn.disabled = false;
        trainingIcon.className = 'fas fa-exclamation-triangle me-2';
        trainingBtnText.textContent = 'Training Failed';
        trainingBtn.classList.remove('btn-warning');
        trainingBtn.classList.add('btn-danger');
        
        // Show error message
        const errorMessage = error.message || 'An unexpected error occurred during training';
        showTrainingError(errorMessage);
        
        // Reset button after 5 seconds
        setTimeout(() => {
            trainingIcon.className = 'fas fa-brain me-2';
            trainingBtnText.textContent = '{{ "Retrain Chatbot" if chatbot.is_trained else "Train Chatbot" }}';
            trainingBtn.classList.remove('btn-danger');
            trainingBtn.classList.add('btn-success');
        }, 5000);
    });
}

function showTrainingProgress() {
    // Create and show training progress notification
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastHtml = `
        <div class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true" id="trainingProgressToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Training your chatbot... This may take a few minutes.
                </div>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toast = document.getElementById('trainingProgressToast');
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

function showTrainingSuccess() {
    // Remove progress toast
    const progressToast = document.getElementById('trainingProgressToast');
    if (progressToast) {
        progressToast.remove();
    }
    
    // Show success toast
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastHtml = `
        <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    Chatbot training completed successfully!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toast = toastContainer.lastElementChild;
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove from DOM after hiding
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function showTrainingError(errorMessage) {
    // Remove progress toast
    const progressToast = document.getElementById('trainingProgressToast');
    if (progressToast) {
        progressToast.remove();
    }
    
    // Show error toast
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastHtml = `
        <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Training failed: ${errorMessage}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toast = toastContainer.lastElementChild;
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove from DOM after hiding
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function updateChatbotStatus(isTrained) {
    // Update the training status badge
    const statusBadge = document.querySelector('.badge');
    if (statusBadge) {
        if (isTrained) {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'Trained & Ready';
        } else {
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = 'Not Trained';
        }
    }
    
    // Show/hide test chat section
    const testChatSection = document.getElementById('test-chat-section');
    if (testChatSection) {
        testChatSection.style.display = isTrained ? 'block' : 'none';
        console.log(`Test chat section ${isTrained ? 'shown' : 'hidden'}`);
    } else {
        console.log('Test chat section not found');
    }
}

function updateDocumentStatus() {
    // Find all document status badges and update them to "Processed"
    const statusBadges = document.querySelectorAll('tbody tr td:nth-child(3) .badge');
    statusBadges.forEach(badge => {
        if (badge.textContent.trim() === 'Pending') {
            badge.className = 'badge bg-success';
            badge.textContent = 'Processed';
        }
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

function convertLinksToHtml(text) {
    if (!text) return text;
    
    let processedText = text;
    
    // Format text for better readability
    processedText = formatTextForChat(processedText);
    
    // URL regex pattern (matches http, https, www, and domain patterns)
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi;
    
    // Email regex pattern
    const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi;
    
    // Convert URLs to clickable links
    processedText = processedText.replace(urlRegex, (match) => {
        let url = match;
        // Add https:// if the URL doesn't have a protocol
        if (!url.match(/^https?:\/\//i)) {
            url = 'https://' + url;
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="chatbot-link">${match}</a>`;
    });
    
    // Convert emails to clickable mailto links
    processedText = processedText.replace(emailRegex, (match) => {
        return `<a href="mailto:${match}" class="chatbot-link chatbot-email-link">${match}</a>`;
    });
    
    return processedText;
}

function formatTextForChat(text) {
    if (!text) return text;
    
    let formattedText = text;
    
    // Parse and format JSON tables first
    formattedText = parseJsonTables(formattedText);
    
    // Convert line breaks to HTML
    formattedText = formattedText.replace(/\n/g, '<br>');
    
    // Format plan information with better structure
    formattedText = formatPlanInformation(formattedText);
    
    // Format lists and bullet points
    formattedText = formatLists(formattedText);
    
    // Format bold text patterns
    formattedText = formatBoldText(formattedText);
    
    // Format plan sections with better structure
    formattedText = formatPlanSections(formattedText);
    
    return formattedText;
}

function parseJsonTables(text) {
    /**
     * Parse JSON tables in the text and convert them to HTML tables
     */
    try {
        // Look for JSON objects in the text
        const jsonRegex = /\{[\s\S]*?\}/g;
        let processedText = text;
        
        processedText = processedText.replace(jsonRegex, (jsonMatch) => {
            try {
                const jsonData = JSON.parse(jsonMatch);
                
                // Check if it's a table-like structure
                if (Array.isArray(jsonData) && jsonData.length > 0) {
                    return createTableFromArray(jsonData);
                } else if (typeof jsonData === 'object' && jsonData !== null) {
                    // Check if it has table-like properties
                    if (jsonData.columns || jsonData.rows || jsonData.data) {
                        return createTableFromObject(jsonData);
                    }
                }
                
                // If not a table, return original JSON
                return jsonMatch;
            } catch (e) {
                // If JSON parsing fails, return original text
                return jsonMatch;
            }
        });
        
        return processedText;
    } catch (error) {
        console.error('Error parsing JSON tables:', error);
        return text;
    }
}

function createTableFromArray(data) {
    /**
     * Create HTML table from array of objects
     */
    if (!Array.isArray(data) || data.length === 0) return '';
    
    const firstRow = data[0];
    const columns = Object.keys(firstRow);
    
    let tableHtml = '<div class="table-responsive mb-3"><table class="table table-striped table-bordered">';
    
    // Create header
    tableHtml += '<thead class="table-dark"><tr>';
    columns.forEach(column => {
        tableHtml += `<th>${escapeHtml(column)}</th>`;
    });
    tableHtml += '</tr></thead>';
    
    // Create body
    tableHtml += '<tbody>';
    data.forEach(row => {
        tableHtml += '<tr>';
        columns.forEach(column => {
            const value = row[column] || '';
            tableHtml += `<td>${escapeHtml(String(value))}</td>`;
        });
        tableHtml += '</tr>';
    });
    tableHtml += '</tbody></table></div>';
    
    return tableHtml;
}

function createTableFromObject(data) {
    /**
     * Create HTML table from object with columns/rows structure
     */
    let tableHtml = '<div class="table-responsive mb-3"><table class="table table-striped table-bordered">';
    
    if (data.columns && data.rows) {
        // Standard table structure
        tableHtml += '<thead class="table-dark"><tr>';
        data.columns.forEach(column => {
            tableHtml += `<th>${escapeHtml(column)}</th>`;
        });
        tableHtml += '</tr></thead>';
        
        tableHtml += '<tbody>';
        data.rows.forEach(row => {
            tableHtml += '<tr>';
            if (Array.isArray(row)) {
                row.forEach(cell => {
                    tableHtml += `<td>${escapeHtml(String(cell))}</td>`;
                });
            } else {
                data.columns.forEach(column => {
                    const value = row[column] || '';
                    tableHtml += `<td>${escapeHtml(String(value))}</td>`;
                });
            }
            tableHtml += '</tr>';
        });
        tableHtml += '</tbody>';
    } else if (data.data && Array.isArray(data.data)) {
        // Data array structure
        if (data.data.length > 0) {
            const firstRow = data.data[0];
            const columns = Object.keys(firstRow);
            
            tableHtml += '<thead class="table-dark"><tr>';
            columns.forEach(column => {
                tableHtml += `<th>${escapeHtml(column)}</th>`;
            });
            tableHtml += '</tr></thead>';
            
            tableHtml += '<tbody>';
            data.data.forEach(row => {
                tableHtml += '<tr>';
                columns.forEach(column => {
                    const value = row[column] || '';
                    tableHtml += `<td>${escapeHtml(String(value))}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody>';
        }
    }
    
    tableHtml += '</table></div>';
    return tableHtml;
}

function escapeHtml(text) {
    /**
     * Escape HTML characters to prevent XSS
     */
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPlanInformation(text) {
    // Look for plan patterns and format them nicely
    const planRegex = /(Plan Name|Plan Price|Plan Purpose|Plan Features)[\s-]*([^\n]+)/gi;
    
    return text.replace(planRegex, (match, label, content) => {
        const cleanLabel = label.replace(/[\s-]+$/, '').trim();
        const cleanContent = content.trim();
        
        // Create a styled label
        const styledLabel = `<strong class="text-primary">${cleanLabel}:</strong>`;
        
        // If it's features, format as a list
        if (cleanLabel.toLowerCase().includes('features')) {
            const features = cleanContent.split('|').map(feature => 
                `<li class="mb-1">${feature.trim()}</li>`
            ).join('');
            return `${styledLabel}<ul class="mb-3 mt-2">${features}</ul>`;
        }
        
        // For other fields, just bold the label
        return `${styledLabel} ${cleanContent}`;
    });
}

function formatLists(text) {
    // Convert simple lists (lines starting with - or *)
    const listRegex = /^[\s]*[-*]\s+(.+)$/gm;
    
    return text.replace(listRegex, (match, content) => {
        return `<li class="mb-1">${content.trim()}</li>`;
    });
}

function formatBoldText(text) {
    // Format common bold patterns
    const boldPatterns = [
        // Plan names and important terms
        { regex: /\b(Free|Starter|Basic|Premium|Enterprise)\b/gi, replacement: '<strong class="text-primary">$1</strong>' },
        // Prices
        { regex: /(\$\d+(?:\.\d{2})?)/g, replacement: '<strong class="text-success">$1</strong>' },
        // Important features
        { regex: /\b(API access|Priority support|Custom branding|Advanced analytics)\b/gi, replacement: '<strong class="text-info">$1</strong>' }
    ];
    
    let formattedText = text;
    boldPatterns.forEach(pattern => {
        formattedText = formattedText.replace(pattern.regex, pattern.replacement);
    });
    
    return formattedText;
}

function formatPlanSections(text) {
    // Look for plan sections and format them with better structure
    const planSectionRegex = /(Free|Starter|Basic|Premium|Enterprise)\s+Plan[\s\S]*?(?=(?:Free|Starter|Basic|Premium|Enterprise)\s+Plan|$)/gi;
    
    return text.replace(planSectionRegex, (match) => {
        // Extract plan name
        const planName = match.match(/^(Free|Starter|Basic|Premium|Enterprise)/i)?.[0] || 'Plan';
        
        // Create a structured plan section
        return `<div class="plan-section">
            <div class="plan-title">${planName} Plan</div>
            ${match.replace(/^(Free|Starter|Basic|Premium|Enterprise)\s+Plan\s*/i, '')}
        </div>`;
    });
}

// Global variable to track conversation ID
let conversationId = null;

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    const chatMessages = document.getElementById('chat-messages');
    
    // Clear messages if flag is set (new conversation after end)
    if (window.shouldClearMessages) {
        clearMessages();
        window.shouldClearMessages = false;
        conversationId = null; // Reset conversation ID
    }
    
    // Add user message
    const userDiv = document.createElement('div');
    userDiv.className = 'mb-2 text-end';
    userDiv.innerHTML = `<div class="d-inline-block bg-primary text-white rounded px-3 py-2" style="max-width: 70%;">${message}</div>`;
    chatMessages.appendChild(userDiv);
    
    // Add loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'mb-2';
    loadingDiv.innerHTML = `<div class="d-inline-block bg-light rounded px-3 py-2"><i class="fas fa-spinner fa-spin me-2"></i>Thinking...</div>`;
    chatMessages.appendChild(loadingDiv);
    
    input.value = '';
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Prepare request data with conversation ID
    const requestData = { message: message };
    if (conversationId) {
        requestData.conversation_id = conversationId;
    }
    
    // Send to API
    fetch(`/api/chat/{{ chatbot.embed_code }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading indicator
        chatMessages.removeChild(loadingDiv);
        
        // Store conversation ID for future messages
        if (data.conversation_id) {
            conversationId = data.conversation_id;
        }
        
        // Add bot response
        const botDiv = document.createElement('div');
        botDiv.className = 'mb-2';
        const processedResponse = convertLinksToHtml(data.response);
        botDiv.innerHTML = `<div class="d-inline-block bg-light rounded px-3 py-2" style="max-width: 70%;"><i class="fas fa-robot me-2 text-primary"></i>${processedResponse}</div>`;
        chatMessages.appendChild(botDiv);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
        // Remove loading indicator
        chatMessages.removeChild(loadingDiv);
        
        // Add error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'mb-2';
        errorDiv.innerHTML = `<div class="d-inline-block bg-danger text-white rounded px-3 py-2" style="max-width: 70%;">Sorry, I encountered an error. Please try again.</div>`;
        chatMessages.appendChild(errorDiv);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

function showEndConversationDialog() {
    const chatMessages = document.getElementById('chat-messages');
    
    // Add bot message asking if questions are answered
    const botDiv = document.createElement('div');
    botDiv.className = 'mb-2';
    botDiv.innerHTML = `<div class="d-inline-block bg-light rounded px-3 py-2" style="max-width: 70%;"><i class="fas fa-robot me-2 text-primary"></i>Have I answered all your questions?</div>`;
    chatMessages.appendChild(botDiv);
    
    // Add Yes/No buttons
    const buttonDiv = document.createElement('div');
    buttonDiv.className = 'mb-2';
    buttonDiv.innerHTML = `
        <div class="d-inline-block bg-light rounded px-3 py-2" style="max-width: 70%;">
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-success btn-sm" onclick="handleEndConversationResponse(true)">
                    <i class="fas fa-check me-1"></i>Yes
                </button>
                <button class="btn btn-secondary btn-sm" onclick="handleEndConversationResponse(false)">
                    <i class="fas fa-times me-1"></i>No
                </button>
            </div>
        </div>
    `;
    chatMessages.appendChild(buttonDiv);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function handleEndConversationResponse(isResolved) {
    const chatMessages = document.getElementById('chat-messages');
    
    if (isResolved) {
        // Mark conversation as resolved
        markConversationResolved();
        
        // Add bot response
        const botDiv = document.createElement('div');
        botDiv.className = 'mb-2';
        botDiv.innerHTML = `<div class="d-inline-block bg-light rounded px-3 py-2" style="max-width: 70%;"><i class="fas fa-robot me-2 text-primary"></i>Great! I'm glad I could help. Feel free to start a new conversation anytime!</div>`;
        chatMessages.appendChild(botDiv);
        
        // Set flag to clear messages on next interaction
        window.shouldClearMessages = true;
        
        // Auto-hide chat section after 5 seconds
        setTimeout(() => {
            const chatSection = document.getElementById('test-chat-section');
            if (chatSection) {
                chatSection.style.display = 'none';
            }
        }, 5000);
    } else {
        // Ask what other questions they have
        const botDiv = document.createElement('div');
        botDiv.className = 'mb-2';
        botDiv.innerHTML = `<div class="d-inline-block bg-light rounded px-3 py-2" style="max-width: 70%;"><i class="fas fa-robot me-2 text-primary"></i>What other questions can I help you with?</div>`;
        chatMessages.appendChild(botDiv);
    }
    
    // Remove the Yes/No buttons
    const buttonContainer = chatMessages.querySelector('.d-flex.gap-2.justify-content-center');
    if (buttonContainer) {
        buttonContainer.closest('.mb-2').remove();
    }
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function markConversationResolved() {
    // Send request to mark conversation as resolved
    if (conversationId) {
        fetch(`/api/chat/{{ chatbot.embed_code }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'end_conversation',
                conversation_id: conversationId,
                resolved: true
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Conversation marked as resolved:', data);
        })
        .catch(error => {
            console.error('Error marking conversation as resolved:', error);
        });
    }
}

function clearMessages() {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        // Clear all messages and show initial greeting
        chatMessages.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-robot me-2"></i>Hi! I'm your chatbot. Ask me anything based on the documents you've uploaded.
            </div>
        `;
    }
}

// Avatar selection for edit mode
document.addEventListener('DOMContentLoaded', function() {
    // Handle predefined avatar selection in edit mode
    const editAvatarOptions = document.querySelectorAll('.edit-avatar-option');
    const editSelectedAvatarInput = document.getElementById('edit-selected-avatar');
    const editFileInput = document.getElementById('edit-avatar');
    
    editAvatarOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all options
            editAvatarOptions.forEach(opt => {
                opt.querySelector('img').style.border = '2px solid transparent';
            });
            
            // Add active class to selected option
            this.querySelector('img').style.border = '2px solid #007bff';
            
            // Set the selected avatar value
            const avatarName = this.getAttribute('data-avatar');
            editSelectedAvatarInput.value = avatarName;
            
            // Clear file input when predefined avatar is selected
            editFileInput.value = '';
        });
    });
    
    // Clear predefined selection when file is uploaded
    editFileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            // Clear predefined selection
            editSelectedAvatarInput.value = '';
            editAvatarOptions.forEach(opt => {
                opt.querySelector('img').style.border = '2px solid transparent';
            });
        }
    });
    
    // Handle tab switching in edit mode
    const editUploadTab = document.getElementById('edit-upload-tab');
    const editPredefinedTab = document.getElementById('edit-predefined-tab');
    
    editUploadTab.addEventListener('click', function() {
        // Clear predefined selection when switching to upload tab
        editSelectedAvatarInput.value = '';
        editAvatarOptions.forEach(opt => {
            opt.querySelector('img').style.border = '2px solid transparent';
        });
    });
    
    editPredefinedTab.addEventListener('click', function() {
        // Clear file input when switching to predefined tab
        editFileInput.value = '';
    });
});
</script>

<style>
.avatar-preview:hover {
    border-color: #007bff !important;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

.avatar-option.selected img,
.edit-avatar-option.selected img {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Chatbot link styles for test chat */
.chatbot-link {
    color: #007bff;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
    word-break: break-all;
}

.chatbot-link:hover {
    color: #0056b3;
    border-bottom-color: #0056b3;
    text-decoration: none;
}

.chatbot-email-link {
    color: #28a745;
}

.chatbot-email-link:hover {
    color: #1e7e34;
    border-bottom-color: #1e7e34;
}

/* Enhanced chat formatting styles */
.chat-messages ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.chat-messages li {
    margin-bottom: 0.25rem;
    line-height: 1.4;
}

.chat-messages strong {
    font-weight: 600;
}

.chat-messages .text-primary {
    color: #007bff !important;
}

.chat-messages .text-success {
    color: #28a745 !important;
}

.chat-messages .text-info {
    color: #17a2b8 !important;
}

/* Plan information styling */
.chat-messages .plan-section {
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 0.75rem;
    margin: 0.5rem 0;
    border-radius: 0.25rem;
}

.chat-messages .plan-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #007bff;
    margin-bottom: 0.5rem;
}

/* JSON Table Styles */
.chat-messages .table-responsive {
    margin: 1rem 0;
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.chat-messages .table {
    margin-bottom: 0;
    font-size: 0.875rem;
}

.chat-messages .table thead th {
    background-color: #343a40;
    border-color: #454d55;
    color: #fff;
    font-weight: 600;
    padding: 0.75rem;
    text-align: left;
}

.chat-messages .table tbody td {
    padding: 0.75rem;
    vertical-align: top;
    border-color: #dee2e6;
}

.chat-messages .table tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.02);
}

.chat-messages .table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.chat-messages .table-bordered {
    border: 1px solid #dee2e6;
}

.chat-messages .table-bordered th,
.chat-messages .table-bordered td {
    border: 1px solid #dee2e6;
}

.avatar-option,
.edit-avatar-option {
    padding: 5px;
    min-height: 110px;
    display: flex;
    align-items: center;
    justify-content: center;
}

</style>

{% endblock %} 