{% extends "admin/base.html" %}

{% block page_title %}Platform Settings{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-home me-2"></i>
                    Homepage Chatbot Configuration
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure which chatbot appears on the homepage and customize its appearance.</p>
                
                <form id="homepage-form">
                    <div class="mb-3">
                        <label for="homepage_chatbot_id" class="form-label">Homepage Chatbot</label>
                        <select class="form-select" id="homepage_chatbot_id" name="homepage_chatbot_id">
                            <option value="">Select a trained chatbot...</option>
                            {% for chatbot in trained_chatbots %}
                                <option value="{{ chatbot.id }}" 
                                        {% if current_chatbot_id and current_chatbot_id|int == chatbot.id %}selected{% endif %}>
                                    {{ chatbot.name }} (by {{ chatbot.owner.username }})
                                    {% if chatbot.embed_code == 'a80eb9ae-21cb-4b87-bfa4-2b3a0ec6cafb' %} - Default Demo{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Choose which trained chatbot should appear on the homepage. Only trained chatbots are available.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="homepage_chatbot_title" class="form-label">Chatbot Title</label>
                        <input type="text" class="form-control" id="homepage_chatbot_title" 
                               name="homepage_chatbot_title" value="{{ current_title }}" 
                               placeholder="Platform Assistant">
                        <div class="form-text">
                            The title that appears in the chatbot widget header.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="homepage_chatbot_placeholder" class="form-label">Input Placeholder</label>
                        <input type="text" class="form-control" id="homepage_chatbot_placeholder" 
                               name="homepage_chatbot_placeholder" value="{{ current_placeholder }}" 
                               placeholder="Ask me anything about the platform...">
                        <div class="form-text">
                            The placeholder text that appears in the message input field.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Settings
                        </button>
                        <a href="{{ url_for('index') }}" target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-external-link-alt me-2"></i>
                            Preview Homepage
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Contact Page Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-envelope me-2"></i>
                    Contact Page Settings
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Customize the "Get in Touch" section on the contact page.</p>
                
                <form id="contact-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact_email" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="contact_email" 
                                       name="contact_email" value="{{ current_contact_email }}" 
                                       placeholder="support@owlbee.ai">
                                <div class="form-text">
                                    The email address displayed in the contact information.
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact_response_time" class="form-label">Response Time</label>
                                <input type="text" class="form-control" id="contact_response_time" 
                                       name="contact_response_time" value="{{ current_contact_response_time }}" 
                                       placeholder="We typically respond within 24 hours">
                                <div class="form-text">
                                    Text describing your typical response time.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contact_support_hours" class="form-label">Support Hours</label>
                        <textarea class="form-control" id="contact_support_hours" 
                                  name="contact_support_hours" rows="3" 
                                  placeholder="Monday - Friday&#10;9:00 AM - 6:00 PM (EST)">{{ current_contact_support_hours }}</textarea>
                        <div class="form-text">
                            Support hours information. Use line breaks to separate days and times.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contact_live_chat_text" class="form-label">Live Chat Text</label>
                        <textarea class="form-control" id="contact_live_chat_text" 
                                  name="contact_live_chat_text" rows="2" 
                                  placeholder="Try our Platform Assistant chatbot in the bottom-right corner for instant help!">{{ current_contact_live_chat_text }}</textarea>
                        <div class="form-text">
                            Description text for the live chat section.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Contact Settings
                        </button>
                        <a href="{{ url_for('contact') }}" target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-external-link-alt me-2"></i>
                            Preview Contact Page
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- OpenAI Model Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>
                    OpenAI Model Settings
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure which OpenAI model to use for chatbot responses. </p>
                
                <form id="openai-form">
                    <div class="mb-3">
                        <label for="openai_model" class="form-label">OpenAI Model</label>
                        <select class="form-select" id="openai_model" name="openai_model">
                            <option value="gpt-5" {% if current_openai_model == 'gpt-5' %}selected{% endif %}>
                                GPT-5 - Most capable, higher cost
                            </option>
                            <option value="gpt-5-mini" {% if current_openai_model == 'gpt-5-mini' %}selected{% endif %}>
                                GPT-5-mini - Fast and cost-effective
                            </option>
                            <option value="gpt-4" {% if current_openai_model == 'gpt-4' %}selected{% endif %}>
                                GPT-4 - Most capable, higher cost
                            </option>
                            <option value="gpt-4o-mini" {% if current_openai_model == 'gpt-4o-mini' %}selected{% endif %}>
                                GPT-4o Mini - Compact and efficient
                            </option>
                            <option value="gpt-4.1" {% if current_openai_model == 'gpt-4.1' %}selected{% endif %}>
                                GPT-4.1 - Most capable, higher cost
                            </option>
                            <option value="gpt-4.1-mini" {% if current_openai_model == 'gpt-4.1-mini' %}selected{% endif %}>
                                GPT-4.1 Mini - Compact and efficient
                            </option>
                        </select>
                        <div class="form-text">
                            Choose the OpenAI model for chatbot responses. 
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Model Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Training Prompt Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain me-2"></i>
                    Training Prompt Settings
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure the internal training instructions that guide how chatbots respond to users.</p>
                
                <form id="training-prompt-form">
                    <div class="mb-3">
                        <label for="training_prompt" class="form-label">Training Instructions</label>
                        <textarea class="form-control" id="training_prompt" name="training_prompt" rows="15" 
                                  placeholder="Enter the training instructions...">{{ current_training_prompt }}</textarea>
                        <div class="form-text">
                            <strong>These instructions are sent to OpenAI along with the training documents.</strong><br>
                            Use variables like <code>{base_prompt}</code>, <code>{context_text}</code> to customize the prompt structure.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Training Prompt
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetTrainingPrompt()">
                            <i class="fas fa-undo me-2"></i>
                            Reset to Default
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Stripe Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card me-2"></i>
                    Stripe Payment Settings
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure Stripe payment integration for future payment processing.</p>
                
                <form id="stripe-form">
                    <div class="mb-3">
                        <label for="stripe_publishable_key" class="form-label">Stripe Publishable Key</label>
                        <input type="text" class="form-control" id="stripe_publishable_key" 
                               name="stripe_publishable_key" value="{{ current_stripe_publishable_key }}" 
                               placeholder="pk_test_... or pk_live_...">
                        <div class="form-text">
                            Your Stripe publishable key (starts with pk_test_ or pk_live_).
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stripe_secret_key" class="form-label">Stripe Secret Key</label>
                        <input type="password" class="form-control" id="stripe_secret_key" 
                               name="stripe_secret_key" value="{{ current_stripe_secret_key }}" 
                               placeholder="sk_test_... or sk_live_...">
                        <div class="form-text">
                            Your Stripe secret key (starts with sk_test_ or sk_live_). Keep this secure!
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stripe_webhook_secret" class="form-label">Stripe Webhook Secret</label>
                        <input type="password" class="form-control" id="stripe_webhook_secret" 
                               name="stripe_webhook_secret" value="{{ current_stripe_webhook_secret }}" 
                               placeholder="whsec_...">
                        <div class="form-text">
                            Your Stripe webhook endpoint secret (starts with whsec_). Used to verify webhook signatures.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Stripe Settings
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="toggleStripeKeyVisibility()">
                            <i class="fas fa-eye me-2"></i>
                            Show/Hide Keys
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Current Configuration
                </h5>
            </div>
            <div class="card-body">
                {% if current_chatbot %}
                    <div class="mb-3">
                        <strong>Active Chatbot:</strong><br>
                        <div class="d-flex align-items-center mt-2">
                            <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                 style="width: 32px; height: 32px; font-size: 14px;">
                                {% if current_chatbot.avatar_url %}
                                    <img src="{{ current_chatbot.avatar_url }}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                    <i class="fas fa-robot"></i>
                                {% endif %}
                            </div>
                            <div>
                                <div class="fw-bold">{{ current_chatbot.name }}</div>
                                <small class="text-muted">by {{ current_chatbot.owner.username }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Embed Code:</strong><br>
                        <code class="small">{{ current_chatbot.embed_code }}</code>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Training Status:</strong><br>
                        <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>Trained
                        </span>
                        <small class="text-muted d-block mt-1">
                            {{ current_chatbot.documents|length }} document(s),
                            {{ current_chatbot.conversations|length }} conversation(s)
                        </small>
                    </div>
                    
                    {% if current_chatbot.system_prompt %}
                        <div class="mb-3">
                            <strong>System Prompt:</strong><br>
                            <div class="bg-light p-2 rounded small">
                                {{ current_chatbot.system_prompt[:100] }}{% if current_chatbot.system_prompt|length > 100 %}...{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Avatar and Training Management -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="mb-3">
                            <i class="fas fa-cog me-2"></i>
                            Manage Chatbot
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Avatar</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="avatar-preview" style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                            {% if current_chatbot.avatar_url %}
                                                <img src="{{ current_chatbot.avatar_url }}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
                                            {% else %}
                                                <i class="fas fa-robot text-muted"></i>
                                            {% endif %}
                                        </div>
                                        <a href="{% if current_chatbot.url_name and current_chatbot.owner %}{{ url_for('chatbot_details_by_name', username=current_chatbot.owner.username, chatbot_name=current_chatbot.url_name) }}{% else %}{{ url_for('chatbot_details', chatbot_id=current_chatbot.id) }}{% endif %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-edit me-1"></i>
                                            Update Avatar
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Training Documents</label>
                                    <div>
                                        <a href="{% if current_chatbot.url_name and current_chatbot.owner %}{{ url_for('chatbot_details_by_name', username=current_chatbot.owner.username, chatbot_name=current_chatbot.url_name) }}{% else %}{{ url_for('chatbot_details', chatbot_id=current_chatbot.id) }}{% endif %}" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-upload me-1"></i>
                                            Upload Documents
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-robot fa-2x mb-2"></i>
                        <p>No chatbot configured for homepage</p>
                        <small>Select a trained chatbot above to display on the homepage.</small>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-code me-2"></i>
                    Integration
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    The homepage chatbot is automatically embedded on your website's homepage. 
                    Visitors can interact with it without needing to register or login.
                </p>
                
                <div class="d-grid gap-2">
                    <a href="{{ url_for('index') }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-2"></i>
                        View Live Homepage
                    </a>
                    {% if current_chatbot_id %}
                        <button class="btn btn-outline-info btn-sm" onclick="testChatbot()">
                            <i class="fas fa-comment me-2"></i>
                            Test Chatbot
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Available Chatbots Info -->
{% if trained_chatbots %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Available Trained Chatbots ({{ trained_chatbots|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for chatbot in trained_chatbots %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 {% if current_chatbot_id and current_chatbot_id|int == chatbot.id %}border-primary{% endif %}">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 32px; height: 32px; font-size: 14px;">
                                                <i class="fas fa-robot"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ chatbot.name }}</div>
                                                <small class="text-muted">by {{ chatbot.owner.username }}</small>
                                            </div>
                                        </div>
                                        
                                        {% if chatbot.description %}
                                            <p class="small text-muted mb-2">{{ chatbot.description }}</p>
                                        {% endif %}
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">
                                                    {{ chatbot.documents|length }} docs, 
                                                    {{ chatbot.conversations|length }} chats
                                                </small>
                                            </div>
                                            {% if current_chatbot_id and current_chatbot_id|int == chatbot.id %}
                                                <span class="badge bg-primary">Active</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No trained chatbots available.</strong> 
                Users need to create and train chatbots before they can be used on the homepage.
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// AJAX form submission functions
function submitForm(formId, endpoint) {
    const form = document.getElementById(formId);
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    submitBtn.disabled = true;
    
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-success');
            
            // Show flash message
            showFlashMessage(data.message, 'success');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-primary');
                submitBtn.disabled = false;
            }, 2000);
        } else {
            throw new Error(data.message || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-danger');
        
        showFlashMessage('Error: ' + error.message, 'danger');
        
        // Reset button after 3 seconds
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.classList.remove('btn-danger');
            submitBtn.classList.add('btn-primary');
            submitBtn.disabled = false;
        }, 3000);
    });
}

function showFlashMessage(message, type) {
    // Create flash message element
    const flashDiv = document.createElement('div');
    flashDiv.className = `alert alert-${type} alert-dismissible fade show`;
    flashDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of content
    const content = document.querySelector('.row');
    content.insertBefore(flashDiv, content.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (flashDiv.parentNode) {
            flashDiv.remove();
        }
    }, 5000);
}

// Form event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Homepage form
    document.getElementById('homepage-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('homepage-form', '/admin/settings/homepage');
    });
    
    // Contact form
    document.getElementById('contact-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('contact-form', '/admin/settings/contact');
    });
    
    // OpenAI form
    document.getElementById('openai-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('openai-form', '/admin/settings/openai');
    });
    
    // Stripe form
    document.getElementById('stripe-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('stripe-form', '/admin/settings/stripe');
    });
    
    // Training prompt form
    document.getElementById('training-prompt-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('training-prompt-form', '/admin/settings/training-prompt');
    });
});

function testChatbot() {
    // Open homepage in new tab and scroll to chatbot
    const homepage = window.open('{{ url_for("index") }}', '_blank');
    
    // Show success message
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-2"></i>Opened!';
    btn.classList.remove('btn-outline-info');
    btn.classList.add('btn-success');
    
    setTimeout(function() {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-info');
    }, 2000);
}

function toggleStripeKeyVisibility() {
    const secretKeyInput = document.getElementById('stripe_secret_key');
    const webhookSecretInput = document.getElementById('stripe_webhook_secret');
    const toggleBtn = event.target;
    
    if (secretKeyInput.type === 'password') {
        secretKeyInput.type = 'text';
        webhookSecretInput.type = 'text';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash me-2"></i>Hide Keys';
    } else {
        secretKeyInput.type = 'password';
        webhookSecretInput.type = 'password';
        toggleBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Show Keys';
    }
}

function resetTrainingPrompt() {
    const defaultPrompt = `{base_prompt}

TRAINING DOCUMENTS CONTEXT:
{context_text}

CRITICAL INSTRUCTIONS - TRAINING DOCUMENT PRIORITY:
1. ALWAYS answer questions based on the training documents provided above FIRST
2. ONLY use your general knowledge or web search if the training documents don't contain relevant information
3. When training documents contain relevant information, base your response entirely on that content
4. If training documents have conflicting information with general knowledge, prioritize the training documents
5. Never contradict information from the training documents with external knowledge
6. If you must use general knowledge or web search, clearly state that the training documents don't cover that specific aspect

RESPONSE GUIDELINES:
1. Follow your role as defined above
2. Use the information from the training documents when relevant
3. If the context doesn't contain enough information to answer the question, you may use your general knowledge while staying in character
4. Be conversational and helpful in your tone
5. Keep your answers concise but complete
6. If you see Q&A pairs in the context, use them to inform your responses
7. If multiple pieces of context are relevant, synthesize them into a coherent answer
8. IMPORTANT: After providing your answer, always end with a follow-up question to encourage continued conversation. Use phrases like:
   - "May I help you with anything else?"
   - "Have I answered all of your questions?"
   - "Is there anything else you'd like to know about this topic?"
   - "Would you like me to explain anything else?"
   - "Do you have any other questions?"

Remember: Stay in character as defined in your role, and ALWAYS prioritize information from the training documents when available.`;

    if (confirm('Are you sure you want to reset the training prompt to the default? This will overwrite your current changes.')) {
        document.getElementById('training_prompt').value = defaultPrompt;
    }
}
</script>
{% endblock %}